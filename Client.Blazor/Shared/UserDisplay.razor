@inject IAuthService AuthService

@using Agridea.Acorda.AcordaControlOffline.Shared.Domain
@using Agridea.Acorda.AcordaControlOffline.Client.Blazor.Auth
@using System.Security.Claims
<li class="nav-item dropdown">
    <a class="nav-link" data-toggle="dropdown" href="#">
        <i class="fas fa-user mr-1"></i>
        @if (isSignedIn)
        {
            <span>@username</span>
        }
        else
        { <span>@Canton.Unselected</span>}
    </a>
    <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
        <div class="dropdown-header bg-gradient-success">
            <span class="fa-stack fa-3x">
                <i class="far fa-square fa-stack-2x fa-inverse"></i>
                <i class="fas fa-user fa-stack-1x fa-inverse"></i>
            </span>
            @if (isSignedIn)
            {
                <p>@username</p>
                <p><small>@role</small></p>
            }
            else
            {
                <p>Aucun utilisateur connecté</p>
            }
        </div>
        <div class="dropdown-divider"></div>
        <div class="dropdown-footer text-left">
            @if (isSignedIn)
            {
                <button type="button" class="btn btn-default mb-1"><i class="fas fa-sign-out-alt" @onclick="@Logout"></i> Déconnexion</button>
                <button type="button" class="btn btn-default mb-1"><i class="fas fa-lock"></i> Changer mot de passe</button>
            }
            else
            {
                <button type="button" class="btn btn-default mb-1"><i class="fas fa-sign-in-alt"></i> Connexion</button>
            }
        </div>
    </div>
</li>
@code {
    [CascadingParameter]
    public Task<AuthenticationState> AuthState { get; set; }

    bool isSignedIn = false;
    string username = "";
    string role = "";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthState;
        var principal = authState.User;
        username = principal.Claims.FirstOrDefault(x => x.Type == ClaimTypes.Name)?.Value ?? "";
        role = principal.Claims.FirstOrDefault(x => x.Type == ClaimTypes.Role)?.Value ?? "";
        isSignedIn = authState.User.Identity.IsAuthenticated;
    }

    public async Task Logout()
    {
        await AuthService.Logout();
    }
}
